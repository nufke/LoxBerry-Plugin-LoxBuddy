"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[8366],{8366:(B,x,p)=>{p.r(x),p.d(x,{CategoriesPageModule:()=>$});var g=p(9843),h=p(4282),m=p(6814),S=p(6223),v=p(9515),T=p(2572),P=p(7398),e=p(5879),A=p(5e3);function y(i,u){1&i&&(e.TgZ(0,"ion-row")(1,"ion-label",5)(2,"p",6),e._uU(3,"Favorites"),e.qZA()()())}function F(i,u){if(1&i&&(e.TgZ(0,"ion-col",7)(1,"ion-card",8)(2,"ion-card-content",9)(3,"ion-item",10),e._UZ(4,"ion-icon",11),e.qZA(),e.TgZ(5,"ion-item")(6,"ion-label",12)(7,"h1"),e._uU(8),e.qZA()()()()()()),2&i){const c=u.$implicit;e.xp6(1),e.hYB("routerLink","",c.serialNr,"/",c.uuid,""),e.xp6(3),e.s9C("src",c.icon.href),e.xp6(4),e.Oqu(c.name)}}function b(i,u){1&i&&(e.TgZ(0,"ion-row")(1,"ion-label",5)(2,"p",6),e._uU(3,"Other categories"),e.qZA()()())}function L(i,u){if(1&i&&(e.TgZ(0,"ion-col",13)(1,"ion-card",8)(2,"ion-card-content",9)(3,"ion-item",14),e._UZ(4,"ion-icon",15),e.TgZ(5,"ion-label",16)(6,"h1"),e._uU(7),e.qZA()()()()()()),2&i){const c=u.$implicit;e.xp6(1),e.hYB("routerLink","",c.serialNr,"/",c.uuid,""),e.xp6(3),e.s9C("src",c.icon.href),e.xp6(3),e.Oqu(c.name)}}function q(i,u){if(1&i&&(e.TgZ(0,"ion-grid"),e.YNc(1,y,4,0,"ion-row",2),e.TgZ(2,"ion-row"),e.YNc(3,F,9,4,"ion-col",3),e.qZA(),e.YNc(4,b,4,0,"ion-row",2),e.TgZ(5,"ion-row"),e.YNc(6,L,8,4,"ion-col",4),e.qZA()()),2&i){const c=u.ngIf;e.xp6(1),e.Q6J("ngIf",c.categoriesFavs.length),e.xp6(2),e.Q6J("ngForOf",c.categoriesFavs),e.xp6(1),e.Q6J("ngIf",c.categoriesList.length),e.xp6(2),e.Q6J("ngForOf",c.categoriesList)}}let M=(()=>{var i;class u{constructor(t,o){this.translate=t,this.controlService=o}ngOnInit(){this.initVM()}ngOnDestroy(){}ionViewWillEnter(){this.content.scrollToTop()}initVM(){this.vm$=(0,T.a)([this.controlService.controls$,this.controlService.categories$]).pipe((0,P.U)(([t,o])=>this.updateVM(t,o)))}updateVM(t,o){let r=t.filter(l=>l.isVisible).map(l=>l.category),a=o.filter(l=>l.isVisible&&!l.isFavorite&&r.indexOf(l.uuid)>-1).sort((l,s)=>l.order[0]-s.order[0]||l.name.localeCompare(s.name)),d=o.filter(l=>l.isVisible&&l.isFavorite&&r.indexOf(l.uuid)>-1).sort((l,s)=>l.order[1]-s.order[1]||l.name.localeCompare(s.name));return{categories:o,categoriesList:a,categoriesFavs:d}}}return(i=u).\u0275fac=function(t){return new(t||i)(e.Y36(v.sK),e.Y36(A.B))},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-categories"]],viewQuery:function(t,o){if(1&t&&e.Gf(g.W2,5),2&t){let n;e.iGM(n=e.CRH())&&(o.content=n.first)}},decls:10,vars:6,consts:[["slot","start"],["autoHide","false"],[4,"ngIf"],["size","6","size-md","3",4,"ngFor","ngForOf"],["size","12","size-md","6",4,"ngFor","ngForOf"],[1,"control-label"],["translate",""],["size","6","size-md","3"],[1,"card",3,"routerLink"],[1,"card-content"],[1,"ion-text-center"],[1,"icon-list",3,"src"],["text-wrap","",1,"label-list","text-flex"],["size","12","size-md","6"],[1,"item"],[1,"icon",3,"src"],["text-wrap","",1,"label","label-listitem"]],template:function(t,o){1&t&&(e.TgZ(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",0),e._UZ(3,"ion-menu-button",1),e.qZA(),e.TgZ(4,"ion-title"),e._uU(5),e.ALo(6,"translate"),e.qZA()()(),e.TgZ(7,"ion-content"),e.YNc(8,q,7,4,"ion-grid",2),e.ALo(9,"async"),e.qZA()),2&t&&(e.xp6(5),e.Oqu(e.lcZ(6,2,"Categories")),e.xp6(3),e.Q6J("ngIf",e.lcZ(9,4,o.vm$)))},dependencies:[g.Sm,g.PM,g.FN,g.wI,g.W2,g.jY,g.Gu,g.gu,g.Ie,g.Q$,g.fG,g.Nd,g.wd,g.sr,g.YI,m.sg,m.O5,h.rH,v.Pi,m.Ov,v.X$],styles:[".text-flex[_ngcontent-%COMP%]{display:flex;text-align:center}"]}),u})();const O=[{path:"",component:M}];let I=(()=>{var i;class u{}return(i=u).\u0275fac=function(t){return new(t||i)},i.\u0275mod=e.oAB({type:i}),i.\u0275inj=e.cJS({imports:[h.Bz.forChild(O),h.Bz]}),u})(),$=(()=>{var i;class u{}return(i=u).\u0275fac=function(t){return new(t||i)},i.\u0275mod=e.oAB({type:i}),i.\u0275inj=e.cJS({imports:[g.Pc,m.ez,S.u5,h.Bz.forChild([{path:"",component:M}]),I,v.aw.forChild()]}),u})()},5e3:(B,x,p)=>{p.d(x,{B:()=>$});var g=p(7081),h=p(5879),m=p(8468),S=p(5861),v=p(2181),T=p(9360),P=p(2420),e=p(8251),A=p(4829);function y(i){return(0,T.e)((u,c)=>{let t=[];return u.subscribe((0,e.x)(c,o=>t.push(o),()=>{c.next(t),c.complete()})),(0,A.Xf)(i).subscribe((0,e.x)(c,()=>{const o=t;t=[],c.next(o)},P.Z)),()=>{t=null}})}var F=p(2832);function b(i,u=F.z){return(0,T.e)((c,t)=>{let o=null,n=null,r=null;const a=()=>{if(o){o.unsubscribe(),o=null;const f=n;n=null,t.next(f)}};function d(){const f=r+i,l=u.now();if(l<f)return o=this.schedule(void 0,f-l),void t.add(o);a()}c.subscribe((0,e.x)(t,f=>{n=f,r=u.now(),o||(o=u.schedule(d,i),t.add(o))},()=>{a(),t.complete()},void 0,()=>{n=o=null}))})}var L=p(7398),q=p(4244);const M=["/name","/icon/#","/type","/room","/category","/isFavorite","/isVisible","/isSecured","/order","/details/#","/states/#","/subControls/#"];var O=p(9515);let I=(()=>{var i;class u{constructor(t,o,n){this.mqttService=t,this.translate=o,this.dataService=n,this.mqttSubscription=[],this.mqttTopicMapping={},this.mqttPrefixList=[],this.registeredTopics=[],this.loxberryMqttConnected=!1,this.loxberryMqttTopic="",this.initService(),this.mqttService.state.subscribe(r=>{this.loxberryMqttConnected=r===q.B.CONNECTED,console.log("LoxBerry Mqtt client connection status:",this.loxberryMqttConnected?"connected":"disconnected"),this.loxberryMqttConnected&&!this.mqttSubscription[0]&&this.registerStructureTopic(),this.loxberryMqttConnected||this.unregisterTopics()})}initService(){this.dataService.settings$.subscribe(t=>{t&&t.mqtt&&t.mqtt.username&&t.mqtt.password&&t.mqtt.hostname&&t.mqtt.port&&t.mqtt.topic&&(this.loxberryMqttTopic=t.mqtt.topic,this.connectToMqtt(t))})}connectToMqtt(t){console.log("Connecting to LoxBerry MQTT server..."),this.mqttService.connect({username:t.mqtt.username,password:t.mqtt.password,hostname:t.mqtt.hostname,port:t.mqtt.port,keepalive:5,connectTimeout:5e3,reconnectPeriod:5e3,protocol:"wss"})}registerStructureTopic(){var t=this;console.log("Subscribe to structure..."),this.mqttSubscription[0]=this.mqttService.observe(this.loxberryMqttTopic+"/+/structure").subscribe(function(){var n=(0,S.Z)(function*(r){let a=r.payload.toString();0==a.length?(console.log("Clear structure in store..."),t.dataService.flushControlsInStore(r.topic.split("/")[1])):yield t.processStructure(JSON.parse(a),t.loxberryMqttTopic)});return function(r){return n.apply(this,arguments)}}())}processStructure(t,o){var n=this;return(0,S.Z)(function*(){let r={categories:{},rooms:{},controls:{}},a="",d="assets/icons/svg",f=t.msInfo.serialNr;t&&(console.log("Processing received structure..."),Object.keys(t.cats).forEach(l=>{let s=t.cats[l];r.categories[f+"/"+s.uuid]={...s,serialNr:f,icon:{href:d+"/"+s.image},isVisible:!0,order:[s.name.toLowerCase().charCodeAt(0)-86,11-s.defaultRating]}}),Object.keys(t.rooms).forEach(l=>{let s=t.rooms[l];r.rooms[f+"/"+s.uuid]={...s,serialNr:f,icon:{href:d+"/"+s.image,color:s.color},isVisible:!0,order:[s.name.toLowerCase().charCodeAt(0)-86,11-s.defaultRating]}}),Object.keys(t.controls).forEach(l=>{let s=t.controls[l],C=f+"/"+s.uuidAction;s.defaultIcon&&s.defaultIcon.length>0?(a=d+"/"+s.defaultIcon,-1==a.search(".svg")&&(a+=".svg")):a="Daytimer"===s.type?d+"/daytimer.svg":Object.values(r.categories).find(Z=>Z.uuid===s.cat).icon.href,r.controls[C]={...s,serialNr:f,uuid:s.uuidAction,mqtt:o+"/"+f+"/"+s.uuidAction+"/cmd",icon:{href:a},category:s.cat,isFavorite:s.defaultRating>0,isVisible:!0,states:n.processStates(s.states,s.uuidAction,o,f),subControls:n.processSubControls(s,o,f),order:[s.name.toLowerCase().charCodeAt(0)-86,s.name.toLowerCase().charCodeAt(0)-86,s.isFavorite?11-s.defaultRating:0]}}),yield n.dataService.updateStructureInStore(r),n.registerTopics(f))})()}processSubControls(t,o,n){let r={};return t.subControls&&Object.keys(t.subControls).forEach(a=>{let d=t.subControls[a];r[d.uuidAction]={...d,uuid:d.uuidAction,mqtt:o+"/"+n+"/"+d.uuidAction+"/cmd",isVisible:!0,states:this.processStates(d.states,t.uuidAction+"/subControls/"+d.uuidAction,o,n)}}),r}processStates(t,o,n,r){let a={};return t&&Object.keys(t).forEach(d=>{let f=t[d];if(Array.isArray(f)){let l=[];f.forEach((s,C)=>{l.push(void 0);let Z=n+"/"+r+"/"+s;this.mqttTopicMapping[Z]=r+"/"+o+"/states/"+d+"/"+C,this.registerTopicPrefix(Z)}),a[d]=l}else{a[d]=void 0;let l=n+"/"+r+"/"+t[d];this.mqttTopicMapping[l]=r+"/"+o+"/states/"+d,this.registerTopicPrefix(l)}}),a}registerTopicPrefix(t){let o=t.split("/")[0];this.mqttPrefixList.find(n=>n===o)||(this.mqttPrefixList.push(o),console.log("Registered topic prefix: ",o))}registerTopics(t){var o=this;M.forEach(n=>{let r=this.loxberryMqttTopic+"/"+t+"/+/+"+n;this.registeredTopics.includes(r)?console.log("Topic already exists and ignored:",r):(console.log("Register topic name:",r),this.registeredTopics.push(r),this.mqttSubscription.push(this.mqttService.observe(r).pipe((0,v.h)(a=>a.length>0),y(this.mqttService.observe(r).pipe(b(10)))).subscribe(function(){var a=(0,S.Z)(function*(d){yield o.dataService.updateElementsInStore(d)});return function(d){return a.apply(this,arguments)}}())))}),this.mqttPrefixList.forEach(n=>{let r=n+"/#";this.registeredTopics.includes(r)?console.log("Topic already exists and ignored:",r):(console.log("Register topic name:",r),this.registeredTopics.push(r),this.mqttSubscription.push(this.mqttService.observe(r).pipe((0,L.U)(a=>({...a,topic:this.mqttTopicMapping[a.topic]})),(0,v.h)(a=>a.length>0),y(this.mqttService.observe(r).pipe(b(10)))).subscribe(function(){var a=(0,S.Z)(function*(d){yield o.dataService.updateElementsInStore(d)});return function(d){return a.apply(this,arguments)}}())))})}unregisterTopics(){console.log("Unsubscribe from MQTT topics..."),this.mqttSubscription.forEach(t=>{t.unsubscribe()}),this.mqttSubscription=[],this.registeredTopics=[],this.mqttTopicMapping=[]}ngOnDestroy(){this.unregisterTopics()}sendMessage(t,o){let n=t.mqtt;n?(this.mqttService.unsafePublish(n,o),console.log("MQTT publish: ",t.name,n,o)):console.log("Topic "+n+" not found. Nothing published.")}}return(i=u).\u0275fac=function(t){return new(t||i)(h.LFG(q.KZ),h.LFG(O.sK),h.LFG(m.D))},i.\u0275prov=h.Yz7({token:i,factory:i.\u0275fac,providedIn:"root"}),u})(),$=(()=>{var i;class u{constructor(t,o){this.dataService=t,this.loxberryService=o}get controls$(){return this.dataService.select$(t=>Object.values(t.structure.controls)).pipe((0,g.d)())}get categories$(){return this.dataService.select$(t=>Object.values(t.structure.categories)).pipe((0,g.d)())}get rooms$(){return this.dataService.select$(t=>Object.values(t.structure.rooms)).pipe((0,g.d)())}getControl$(t,o){return this.dataService.select$(n=>n.structure.controls[t+"/"+o]).pipe((0,g.d)())}getSubControl$(t,o,n){return this.dataService.select$(r=>r.structure.controls[t+"/"+o].subControls[n]).pipe((0,g.d)())}updateControl(t,o){this.loxberryService.sendMessage(t,o)}}return(i=u).\u0275fac=function(t){return new(t||i)(h.LFG(m.D),h.LFG(I))},i.\u0275prov=h.Yz7({token:i,factory:i.\u0275fac,providedIn:"root"}),u})()}}]);