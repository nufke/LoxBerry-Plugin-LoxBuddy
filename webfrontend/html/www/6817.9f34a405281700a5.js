"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[6817],{6817:($,S,u)=>{u.r(S),u.d(S,{RoomsPageModule:()=>p});var d=u(9843),g=u(6814),T=u(6223),v=u(9515),x=u(4282),y=u(2572),Z=u(7398),e=u(5879),P=u(5e3);function b(r,a){1&r&&(e.TgZ(0,"ion-row")(1,"ion-label",5)(2,"p",6),e._uU(3,"Favorites"),e.qZA()()())}function R(r,a){if(1&r&&(e.TgZ(0,"ion-card",9)(1,"ion-card-content",10)(2,"ion-item",11),e._UZ(3,"ion-icon",12),e.qZA(),e.TgZ(4,"ion-item")(5,"ion-label",13)(6,"h1"),e._uU(7),e.qZA()()()()()),2&r){const t=e.oxw().$implicit;e.hYB("routerLink","",t.serialNr,"/",t.uuid,""),e.xp6(3),e.s9C("src",t.icon.href),e.xp6(4),e.Oqu(t.name)}}function C(r,a){if(1&r&&(e.TgZ(0,"ion-col",7),e.YNc(1,R,8,4,"ion-card",8),e.qZA()),2&r){const t=a.$implicit;e.xp6(1),e.Q6J("ngIf",t.isFavorite)}}function A(r,a){1&r&&(e.TgZ(0,"ion-row")(1,"ion-label",5)(2,"p",6),e._uU(3,"Other rooms"),e.qZA()()())}function q(r,a){if(1&r&&(e.TgZ(0,"ion-col",14)(1,"ion-card",9)(2,"ion-card-content",10)(3,"ion-item",15),e._UZ(4,"ion-icon",16),e.TgZ(5,"ion-label",17)(6,"h1"),e._uU(7),e.qZA()()()()()()),2&r){const t=a.$implicit;e.xp6(1),e.hYB("routerLink","",t.serialNr,"/",t.uuid,""),e.xp6(3),e.s9C("src",t.icon.href),e.xp6(3),e.Oqu(t.name)}}function F(r,a){if(1&r&&(e.TgZ(0,"ion-grid"),e.YNc(1,b,4,0,"ion-row",2),e.TgZ(2,"ion-row"),e.YNc(3,C,2,1,"ion-col",3),e.qZA(),e.YNc(4,A,4,0,"ion-row",2),e.TgZ(5,"ion-row"),e.YNc(6,q,8,4,"ion-col",4),e.qZA()()),2&r){const t=a.ngIf;e.xp6(1),e.Q6J("ngIf",t.roomsFavs.length),e.xp6(2),e.Q6J("ngForOf",t.roomsFavs),e.xp6(1),e.Q6J("ngIf",t.roomsList.length),e.xp6(2),e.Q6J("ngForOf",t.roomsList)}}const L=[{path:"",component:(()=>{var r;class a{constructor(o,s){this.translate=o,this.controlService=s}ngOnInit(){this.initVM()}ngOnDestroy(){}ionViewWillEnter(){this.content.scrollToTop()}initVM(){this.vm$=(0,y.a)([this.controlService.controls$,this.controlService.rooms$]).pipe((0,Z.U)(([o,s])=>this.updateVM(o,s)))}updateVM(o,s){let c=o.filter(i=>i.isVisible).map(i=>i.room),l=s.filter(i=>i.isVisible&&!i.isFavorite&&c.indexOf(i.uuid)>-1).sort((i,h)=>i.order[0]-h.order[0]||i.name.localeCompare(h.name)),m=s.filter(i=>i.isVisible&&i.isFavorite&&c.indexOf(i.uuid)>-1).sort((i,h)=>i.order[1]-h.order[1]||i.name.localeCompare(h.name));return{rooms:s,roomsList:l,roomsFavs:m}}}return(r=a).\u0275fac=function(o){return new(o||r)(e.Y36(v.sK),e.Y36(P.B))},r.\u0275cmp=e.Xpm({type:r,selectors:[["app-rooms"]],viewQuery:function(o,s){if(1&o&&e.Gf(d.W2,5),2&o){let n;e.iGM(n=e.CRH())&&(s.content=n.first)}},decls:10,vars:6,consts:[["slot","start"],["autoHide","false"],[4,"ngIf"],["size","6","size-md","3",4,"ngFor","ngForOf"],["size","12","size-md","6",4,"ngFor","ngForOf"],[1,"control-label"],["translate",""],["size","6","size-md","3"],["class","card","class","card",3,"routerLink",4,"ngIf"],[1,"card",3,"routerLink"],[1,"card-content"],[1,"item","ion-text-center"],[1,"icon-list",3,"src"],["text-wrap","",1,"label-list","text-flex"],["size","12","size-md","6"],[1,"item"],[1,"icon",3,"src"],["text-wrap","",1,"label","label-listitem"]],template:function(o,s){1&o&&(e.TgZ(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",0),e._UZ(3,"ion-menu-button",1),e.qZA(),e.TgZ(4,"ion-title"),e._uU(5),e.ALo(6,"translate"),e.qZA()()(),e.TgZ(7,"ion-content"),e.YNc(8,F,7,4,"ion-grid",2),e.ALo(9,"async"),e.qZA()),2&o&&(e.xp6(5),e.Oqu(e.lcZ(6,2,"Rooms")),e.xp6(3),e.Q6J("ngIf",e.lcZ(9,4,s.vm$)))},dependencies:[d.Sm,d.PM,d.FN,d.wI,d.W2,d.jY,d.Gu,d.gu,d.Ie,d.Q$,d.fG,d.Nd,d.wd,d.sr,d.YI,g.sg,g.O5,x.rH,v.Pi,g.Ov,v.X$],styles:[".text-flex[_ngcontent-%COMP%]{display:flex;text-align:center}"]}),a})()}];let O=(()=>{var r;class a{}return(r=a).\u0275fac=function(o){return new(o||r)},r.\u0275mod=e.oAB({type:r}),r.\u0275inj=e.cJS({imports:[x.Bz.forChild(L),x.Bz]}),a})(),p=(()=>{var r;class a{}return(r=a).\u0275fac=function(o){return new(o||r)},r.\u0275mod=e.oAB({type:r}),r.\u0275inj=e.cJS({imports:[d.Pc,g.ez,T.u5,O,v.aw.forChild()]}),a})()},5e3:($,S,u)=>{u.d(S,{B:()=>O});var d=u(7081),g=u(5879),T=u(8468),v=u(5861),x=u(2181),y=u(9360),Z=u(2420),e=u(8251),P=u(4829);function b(p){return(0,y.e)((r,a)=>{let t=[];return r.subscribe((0,e.x)(a,o=>t.push(o),()=>{a.next(t),a.complete()})),(0,P.Xf)(p).subscribe((0,e.x)(a,()=>{const o=t;t=[],a.next(o)},Z.Z)),()=>{t=null}})}var R=u(2832);function C(p,r=R.z){return(0,y.e)((a,t)=>{let o=null,s=null,n=null;const c=()=>{if(o){o.unsubscribe(),o=null;const m=s;s=null,t.next(m)}};function l(){const m=n+p,f=r.now();if(f<m)return o=this.schedule(void 0,m-f),void t.add(o);c()}a.subscribe((0,e.x)(t,m=>{s=m,n=r.now(),o||(o=r.schedule(l,p),t.add(o))},()=>{c(),t.complete()},void 0,()=>{s=o=null}))})}var A=u(7398),q=u(4244);const F=["/name","/icon/#","/type","/room","/category","/isFavorite","/isVisible","/isSecured","/order","/details/#","/states/#","/subControls/#"];var I=u(9515);let L=(()=>{var p;class r{constructor(t,o,s){this.mqttService=t,this.translate=o,this.dataService=s,this.mqttSubscription=[],this.mqttTopicMapping={},this.mqttPrefixList=[],this.registeredTopics=[],this.loxberryMqttConnected=!1,this.loxberryMqttTopic="",this.initService(),this.mqttService.state.subscribe(n=>{this.loxberryMqttConnected=n===q.B.CONNECTED,console.log("LoxBerry Mqtt client connection status:",this.loxberryMqttConnected?"connected":"disconnected"),this.loxberryMqttConnected&&!this.mqttSubscription[0]&&this.registerStructureTopic(),this.loxberryMqttConnected||this.unregisterTopics()})}initService(){this.dataService.settings$.subscribe(t=>{t&&t.mqtt&&t.mqtt.username&&t.mqtt.password&&t.mqtt.hostname&&t.mqtt.port&&t.mqtt.topic&&(this.loxberryMqttTopic=t.mqtt.topic,this.connectToMqtt(t))})}connectToMqtt(t){console.log("Connecting to LoxBerry MQTT server..."),this.mqttService.connect({username:t.mqtt.username,password:t.mqtt.password,hostname:t.mqtt.hostname,port:t.mqtt.port,keepalive:5,connectTimeout:5e3,reconnectPeriod:5e3,protocol:"wss"})}registerStructureTopic(){var t=this;console.log("Subscribe to structure..."),this.mqttSubscription[0]=this.mqttService.observe(this.loxberryMqttTopic+"/+/structure").subscribe(function(){var s=(0,v.Z)(function*(n){let c=n.payload.toString();0==c.length?(console.log("Clear structure in store..."),t.dataService.flushControlsInStore(n.topic.split("/")[1])):yield t.processStructure(JSON.parse(c),t.loxberryMqttTopic)});return function(n){return s.apply(this,arguments)}}())}processStructure(t,o){var s=this;return(0,v.Z)(function*(){let n={categories:{},rooms:{},controls:{}},c="",l="assets/icons/svg",m=t.msInfo.serialNr;t&&(console.log("Processing received structure..."),Object.keys(t.cats).forEach(f=>{let i=t.cats[f];n.categories[m+"/"+i.uuid]={...i,serialNr:m,icon:{href:l+"/"+i.image},isVisible:!0,order:[i.name.toLowerCase().charCodeAt(0)-86,11-i.defaultRating]}}),Object.keys(t.rooms).forEach(f=>{let i=t.rooms[f];n.rooms[m+"/"+i.uuid]={...i,serialNr:m,icon:{href:l+"/"+i.image,color:i.color},isVisible:!0,order:[i.name.toLowerCase().charCodeAt(0)-86,11-i.defaultRating]}}),Object.keys(t.controls).forEach(f=>{let i=t.controls[f],h=m+"/"+i.uuidAction;i.defaultIcon&&i.defaultIcon.length>0?(c=l+"/"+i.defaultIcon,-1==c.search(".svg")&&(c+=".svg")):c="Daytimer"===i.type?l+"/daytimer.svg":Object.values(n.categories).find(M=>M.uuid===i.cat).icon.href,n.controls[h]={...i,serialNr:m,uuid:i.uuidAction,mqtt:o+"/"+m+"/"+i.uuidAction+"/cmd",icon:{href:c},category:i.cat,isFavorite:i.defaultRating>0,isVisible:!0,states:s.processStates(i.states,i.uuidAction,o,m),subControls:s.processSubControls(i,o,m),order:[i.name.toLowerCase().charCodeAt(0)-86,i.name.toLowerCase().charCodeAt(0)-86,i.isFavorite?11-i.defaultRating:0]}}),yield s.dataService.updateStructureInStore(n),s.registerTopics(m))})()}processSubControls(t,o,s){let n={};return t.subControls&&Object.keys(t.subControls).forEach(c=>{let l=t.subControls[c];n[l.uuidAction]={...l,uuid:l.uuidAction,mqtt:o+"/"+s+"/"+l.uuidAction+"/cmd",isVisible:!0,states:this.processStates(l.states,t.uuidAction+"/subControls/"+l.uuidAction,o,s)}}),n}processStates(t,o,s,n){let c={};return t&&Object.keys(t).forEach(l=>{let m=t[l];if(Array.isArray(m)){let f=[];m.forEach((i,h)=>{f.push(void 0);let M=s+"/"+n+"/"+i;this.mqttTopicMapping[M]=n+"/"+o+"/states/"+l+"/"+h,this.registerTopicPrefix(M)}),c[l]=f}else{c[l]=void 0;let f=s+"/"+n+"/"+t[l];this.mqttTopicMapping[f]=n+"/"+o+"/states/"+l,this.registerTopicPrefix(f)}}),c}registerTopicPrefix(t){let o=t.split("/")[0];this.mqttPrefixList.find(s=>s===o)||(this.mqttPrefixList.push(o),console.log("Registered topic prefix: ",o))}registerTopics(t){var o=this;F.forEach(s=>{let n=this.loxberryMqttTopic+"/"+t+"/+/+"+s;this.registeredTopics.includes(n)?console.log("Topic already exists and ignored:",n):(console.log("Register topic name:",n),this.registeredTopics.push(n),this.mqttSubscription.push(this.mqttService.observe(n).pipe((0,x.h)(c=>c.length>0),b(this.mqttService.observe(n).pipe(C(10)))).subscribe(function(){var c=(0,v.Z)(function*(l){yield o.dataService.updateElementsInStore(l)});return function(l){return c.apply(this,arguments)}}())))}),this.mqttPrefixList.forEach(s=>{let n=s+"/#";this.registeredTopics.includes(n)?console.log("Topic already exists and ignored:",n):(console.log("Register topic name:",n),this.registeredTopics.push(n),this.mqttSubscription.push(this.mqttService.observe(n).pipe((0,A.U)(c=>({...c,topic:this.mqttTopicMapping[c.topic]})),(0,x.h)(c=>c.length>0),b(this.mqttService.observe(n).pipe(C(10)))).subscribe(function(){var c=(0,v.Z)(function*(l){yield o.dataService.updateElementsInStore(l)});return function(l){return c.apply(this,arguments)}}())))})}unregisterTopics(){console.log("Unsubscribe from MQTT topics..."),this.mqttSubscription.forEach(t=>{t.unsubscribe()}),this.mqttSubscription=[],this.registeredTopics=[],this.mqttTopicMapping=[]}ngOnDestroy(){this.unregisterTopics()}sendMessage(t,o){let s=t.mqtt;s?(this.mqttService.unsafePublish(s,o),console.log("MQTT publish: ",t.name,s,o)):console.log("Topic "+s+" not found. Nothing published.")}}return(p=r).\u0275fac=function(t){return new(t||p)(g.LFG(q.KZ),g.LFG(I.sK),g.LFG(T.D))},p.\u0275prov=g.Yz7({token:p,factory:p.\u0275fac,providedIn:"root"}),r})(),O=(()=>{var p;class r{constructor(t,o){this.dataService=t,this.loxberryService=o}get controls$(){return this.dataService.select$(t=>Object.values(t.structure.controls)).pipe((0,d.d)())}get categories$(){return this.dataService.select$(t=>Object.values(t.structure.categories)).pipe((0,d.d)())}get rooms$(){return this.dataService.select$(t=>Object.values(t.structure.rooms)).pipe((0,d.d)())}getControl$(t,o){return this.dataService.select$(s=>s.structure.controls[t+"/"+o]).pipe((0,d.d)())}getSubControl$(t,o,s){return this.dataService.select$(n=>n.structure.controls[t+"/"+o].subControls[s]).pipe((0,d.d)())}updateControl(t,o){this.loxberryService.sendMessage(t,o)}}return(p=r).\u0275fac=function(t){return new(t||p)(g.LFG(T.D),g.LFG(L))},p.\u0275prov=g.Yz7({token:p,factory:p.\u0275fac,providedIn:"root"}),r})()}}]);